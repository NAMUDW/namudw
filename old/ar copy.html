<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Plant AR Lite Demo</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
      height: 100vh;
    }

    .app {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #000;
    }

    video {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
      top: 0;
      left: 0;
      background: #000;
    }

    /* 식물 이미지 컨테이너 */
    .plant-wrapper {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate3d(-50%, -50%, 0) scale(1);
      touch-action: none; /* 브라우저 기본 제스처 막기 (줌/스크롤 등) */
    }

    .plant-image {
      max-width: 40vw;
      width: 40vw;
      height: auto;
      user-select: none;
      pointer-events: none; /* 터치 이벤트는 wrapper에서만 처리 */
    }

    .controls {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 14px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      backdrop-filter: blur(8px);
    }
  </style>
</head>
<body>
<div class="app">
  <video id="camera" autoplay playsinline muted></video>

  <!-- 오버레이 식물 -->
  <div id="plantWrapper" class="plant-wrapper">
    <img src="plant.png" alt="Plant" class="plant-image" />
  </div>

  <!-- 간단한 컨트롤 -->
  <div class="controls">
    <button class="btn" id="resetBtn">초기화</button>
    <button class="btn" id="biggerBtn">조금 크게</button>
    <button class="btn" id="smallerBtn">조금 작게</button>
  </div>
</div>

<script>
  // ===== 1. 카메라 켜기 =====
  async function startCamera() {
    const videoEl = document.getElementById('camera');
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: 'environment' } // 후면 카메라 우선
        },
        audio: false
      });
      videoEl.srcObject = stream;
    } catch (err) {
      console.error('카메라 접근 실패:', err);
      alert('카메라를 사용할 수 없습니다. 권한을 허용했는지 확인해 주세요.');
    }
  }

  // ===== 2. 식물 드래그 + 핀치줌 조작 =====
  const plantWrapper = document.getElementById('plantWrapper');

  let currentX = 0;   // translateX
  let currentY = 0;   // translateY
  let currentScale = 1;

  let startX = 0;     // 터치 시작 기준
  let startY = 0;
  let startScale = 1;
  let startDistance = 0;

  function applyTransform() {
    plantWrapper.style.transform =
      `translate3d(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px), 0) scale(${currentScale})`;
  }

  function getDistance(t1, t2) {
    const dx = t2.clientX - t1.clientX;
    const dy = t2.clientY - t1.clientY;
    return Math.sqrt(dx * dx + dy * dy);
  }

  plantWrapper.addEventListener('touchstart', (e) => {
    e.preventDefault();

    if (e.touches.length === 1) {
      // 드래그 시작
      const t = e.touches[0];
      startX = t.clientX;
      startY = t.clientY;
    } else if (e.touches.length === 2) {
      // 핀치 줌 시작
      const [t1, t2] = e.touches;
      startDistance = getDistance(t1, t2);
      startScale = currentScale;
    }
  }, { passive: false });

  plantWrapper.addEventListener('touchmove', (e) => {
    e.preventDefault();

    if (e.touches.length === 1) {
      // 드래그 중
      const t = e.touches[0];
      const dx = t.clientX - startX;
      const dy = t.clientY - startY;

      // 기준점을 -50%, -50% 에 두었으므로 그 위에 offset을 더해줌
      currentX += dx;
      currentY += dy;

      startX = t.clientX;
      startY = t.clientY;

      applyTransform();
    } else if (e.touches.length === 2) {
      // 핀치 줌 중
      const [t1, t2] = e.touches;
      const dist = getDistance(t1, t2);
      const scaleFactor = dist / startDistance;
      currentScale = Math.max(0.2, Math.min(4, startScale * scaleFactor)); // 최소/최대 제한
      applyTransform();
    }
  }, { passive: false });

  // ===== 3. 버튼으로 크기 조절 =====
  document.getElementById('resetBtn').addEventListener('click', () => {
    currentX = 0;
    currentY = 0;
    currentScale = 1;
    applyTransform();
  });

  document.getElementById('biggerBtn').addEventListener('click', () => {
    currentScale = Math.min(4, currentScale + 0.1);
    applyTransform();
  });

  document.getElementById('smallerBtn').addEventListener('click', () => {
    currentScale = Math.max(0.2, currentScale - 0.1);
    applyTransform();
  });

  // 초기 실행
  startCamera();
  applyTransform();
</script>
</body>
</html>