<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Plant AR Lite Demo (Rotate)</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
      height: 100vh;
    }

    .app {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #000;
    }

    video {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
      top: 0;
      left: 0;
      background: #000;
    }

    .plant-wrapper {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate3d(-50%, -50%, 0) scale(1) rotate(0deg);
      touch-action: none;
    }

    .plant-image {
      max-width: 40vw;
      width: 40vw;
      height: auto;
      user-select: none;
      pointer-events: none;
    }

    .controls {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 14px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      backdrop-filter: blur(8px);
    }
  </style>
</head>
<body>
<div class="app">
  <video id="camera" autoplay playsinline muted></video>

  <!-- 오버레이 식물 -->
  <div id="plantWrapper" class="plant-wrapper">
    <img src="plant.png" alt="Plant" class="plant-image" />
  </div>

  <!-- 간단한 컨트롤 -->
  <div class="controls">
    <button class="btn" id="resetBtn">초기화</button>
    <button class="btn" id="biggerBtn">조금 크게</button>
    <button class="btn" id="smallerBtn">조금 작게</button>
  </div>
</div>

<script>
  // ===== 1. 카메라 켜기 =====
  async function startCamera() {
    const videoEl = document.getElementById('camera');
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: 'environment' }
        },
        audio: false
      });
      videoEl.srcObject = stream;
    } catch (err) {
      console.error('카메라 접근 실패:', err);
      alert('카메라를 사용할 수 없습니다. 권한을 허용했는지 확인해 주세요.');
    }
  }

  // ===== 2. 식물 드래그 + 핀치줌 + 회전 =====
  const plantWrapper = document.getElementById('plantWrapper');

  let currentX = 0;         // 이동 X
  let currentY = 0;         // 이동 Y
  let currentScale = 1;     // 확대/축소
  let currentRotation = 0;  // 회전 (deg)

  let startX = 0;
  let startY = 0;
  let startScale = 1;
  let startRotation = 0;
  let startDistance = 0;
  let startAngle = 0;

  function applyTransform() {
    plantWrapper.style.transform =
      `translate3d(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px), 0) ` +
      `scale(${currentScale}) rotate(${currentRotation}deg)`;
  }

  function getDistance(t1, t2) {
    const dx = t2.clientX - t1.clientX;
    const dy = t2.clientY - t1.clientY;
    return Math.sqrt(dx * dx + dy * dy);
  }

  function getAngle(t1, t2) {
    const dx = t2.clientX - t1.clientX;
    const dy = t2.clientY - t1.clientY;
    return Math.atan2(dy, dx) * 180 / Math.PI; // 라디안 → 도(deg)
  }

  plantWrapper.addEventListener('touchstart', (e) => {
    e.preventDefault();

    if (e.touches.length === 1) {
      const t = e.touches[0];
      startX = t.clientX;
      startY = t.clientY;
    } else if (e.touches.length === 2) {
      const [t1, t2] = e.touches;
      startDistance = getDistance(t1, t2);
      startAngle = getAngle(t1, t2);
      startScale = currentScale;
      startRotation = currentRotation;
    }
  }, { passive: false });

  plantWrapper.addEventListener('touchmove', (e) => {
    e.preventDefault();

    if (e.touches.length === 1) {
      // === 드래그 ===
      const t = e.touches[0];
      const dx = t.clientX - startX;
      const dy = t.clientY - startY;

      currentX += dx;
      currentY += dy;

      startX = t.clientX;
      startY = t.clientY;

      applyTransform();
    } else if (e.touches.length === 2) {
      // === 핀치 + 회전 ===
      const [t1, t2] = e.touches;

      const dist = getDistance(t1, t2);
      const angle = getAngle(t1, t2);

      // scale
      const scaleFactor = dist / startDistance;
      currentScale = Math.max(0.2, Math.min(4, startScale * scaleFactor));

      // rotation
      const angleDelta = angle - startAngle;  // 처음 각도와의 차이
      currentRotation = startRotation + angleDelta;

      applyTransform();
    }
  }, { passive: false });

  // ===== 3. 버튼으로 크기 조절 =====
  document.getElementById('resetBtn').addEventListener('click', () => {
    currentX = 0;
    currentY = 0;
    currentScale = 1;
    currentRotation = 0;
    applyTransform();
  });

  document.getElementById('biggerBtn').addEventListener('click', () => {
    currentScale = Math.min(4, currentScale + 0.1);
    applyTransform();
  });

  document.getElementById('smallerBtn').addEventListener('click', () => {
    currentScale = Math.max(0.2, currentScale - 0.1);
    applyTransform();
  });

  // 초기 실행
  startCamera();
  applyTransform();
</script>
</body>
</html>