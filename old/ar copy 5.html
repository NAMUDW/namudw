<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>나무다운 - 공간 배치 미리보기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-dark: #050509;
      --bg-card: rgba(10, 10, 20, 0.92);
      --accent: #4ade80;
      --accent-soft: rgba(74, 222, 128, 0.18);
      --text-main: #f9fafb;
      --text-sub: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.25);
    }

    html, body {
      touch-action: none;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 50%, #000 100%);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
    }

    .app {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    /* 공통 상단 헤더 */
    .app-header {
      position: absolute;
      top: calc(env(safe-area-inset-top, 0) + 24px);
      left: 0;
      right: 0;
      z-index: 20;
      padding: 12px 18px 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      pointer-events: none;
    }

    .app-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
      pointer-events: auto;
    }

    .app-title-main {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .app-title-sub {
      font-size: 11px;
      color: var(--text-sub);
    }

    .step-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border-subtle);
      font-size: 11px;
      color: var(--text-sub);
      pointer-events: auto;
    }

    .step-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-soft);
    }

    /* 화면 전환용 레이아웃 */
    .screen {
      position: absolute;
      inset: 0;
      padding: calc(90px + env(safe-area-inset-top, 0)) 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      opacity: 0;
      pointer-events: none;
      transform: translateX(12px);
      transition: opacity 0.35s ease, transform 0.35s ease;
    }

    .screen.active {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(0);
    }

    /* ===== 식물 선택 화면 ===== */
    .screen-list {
      background: transparent;
    }

    .intro-card {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 14px 14px 12px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.7);
    }

    .intro-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .intro-desc {
      font-size: 12px;
      color: var(--text-sub);
      line-height: 1.4;
    }

    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .tag {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(31, 41, 55, 0.9);
      color: var(--text-sub);
    }

    .tag.highlight {
      border-color: var(--accent-soft);
      color: var(--accent);
      background: rgba(22, 101, 52, 0.45);
    }

    .plant-grid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      padding-bottom: 8px;
    }

    .plant-card {
      position: relative;
      border-radius: 14px;
      overflow: hidden;
      background: radial-gradient(circle at top, #f9fafb 0, #e5e7eb 40%, #d1d5db 100%);
      border: 1px solid rgba(209, 213, 219, 0.9);
      padding: 6px 6px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      min-height: 112px;
      cursor: pointer;
      touch-action: manipulation;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease, background 0.12s ease;
    }

    .plant-card:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.45);
      border-color: var(--accent);
      background: radial-gradient(circle at top, #fefce8 0, #e5e7eb 45%, #d1d5db 100%);
    }

    .plant-thumb {
      width: 100%;
      aspect-ratio: 3 / 4;
      object-fit: contain;
      filter: drop-shadow(0 6px 10px rgba(15, 23, 42, 0.45));
      pointer-events: none;
    }

    .plant-label {
      margin-top: 4px;
      font-size: 11px;
      color: #4b5563;
      text-align: center;
    }

    .plant-size-chip {
      position: absolute;
      left: 6px;
      top: 6px;
      font-size: 10px;
      padding: 3px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--text-sub);
    }

    .bottom-helper {
      margin-top: auto;
      font-size: 11px;
      color: var(--text-sub);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 0 2px 4px;
    }

    .bottom-helper span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .dot-accent {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: var(--accent);
    }

    /* ===== 카메라 화면 ===== */

    .screen-camera {
      padding: 0;
    }

    .camera-stage {
      position: relative;
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden;
      touch-action: none;
    }

    video {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
      top: 0;
      left: 0;
      background: #000;
    }

    .plant-wrapper {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate3d(-50%, -50%, 0) scale(1) rotate(0deg);
    }

    .plant-image {
      max-width: 45vw;
      width: 45vw;
      height: auto;
      user-select: none;
      pointer-events: none;
      filter: drop-shadow(0 16px 30px rgba(0, 0, 0, 0.85));
    }

    .camera-overlay-gradient {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at bottom, rgba(0,0,0,0.65) 0, transparent 50%),
                  linear-gradient(to top, rgba(15,23,42,0.9), transparent 35%);
    }

    .camera-controls {
      position: absolute;
      left: 0;
      right: 0;
      bottom: max(40px, calc(env(safe-area-inset-bottom, 0) + 32px));
      padding: 0 16px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 15;
      pointer-events: auto;
    }

    .camera-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-sub);
      padding: 4px 4px 0;
    }

    .camera-info span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .camera-button-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 9px 16px;
      font-size: 13px;
      background: rgba(15, 23, 42, 0.90);
      color: var(--text-main);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border-subtle);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      flex: 1;
      justify-content: center;
      background: linear-gradient(135deg, #22c55e, #4ade80);
      border-color: rgba(74, 222, 128, 0.7);
      color: #022c22;
      font-weight: 600;
      box-shadow: 0 10px 30px rgba(22, 163, 74, 0.55);
    }

    .btn-secondary {
      padding-inline: 12px;
      font-size: 12px;
      color: var(--text-sub);
      background: rgba(15, 23, 42, 0.9);
    }

    .size-controls {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      justify-content: center;
      margin-top: 8px;
    }

    /* 버튼 + 라벨 묶음 */
    .control-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .control-label {
      font-size: 10px;
      color: var(--text-sub);
    }

    /* 큰 버튼 */
    .size-btn-small {
      border-radius: 999px;
      width: 40px;
      height: 40px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: #e5e7eb;
      font-size: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.8);
    }

    /* 초기화 버튼은 글자라서 폰트 조금 줄이기 */
    #resetBtn.size-btn-small {
      font-size: 13px;
      padding: 0 8px;
      width: auto;
      min-width: 54px;
    }

    .size-btn-small:active {
      transform: translateY(1px) scale(0.96);
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.9);
    }

    /* 토스트 메시지 */
    .toast {
      position: fixed;
      left: 50%;
      bottom: max(120px, calc(32px + env(safe-area-inset-bottom, 0)));
      transform: translateX(-50%);
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border-subtle);
      color: var(--text-main);
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease, transform 0.25s ease;
      z-index: 40;
    }

    .toast.active {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    /* 버전 표시 */
    .version-badge {
      position: fixed;
      right: 8px;
      bottom: calc(env(safe-area-inset-bottom, 0) + 4px);
      font-size: 10px;
      color: rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.8);
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(55, 65, 81, 0.8);
      z-index: 50;
      pointer-events: none;
    }

    .no-select {
      user-select: none;
      -webkit-user-select: none;
    }
  </style>
</head>
<body>
<div class="app no-select">
  <!-- 공통 헤더 -->
  <header class="app-header">
    <div class="app-title">
      <div class="app-title-main">나무다운</div>
      <div class="app-title-sub">공간에 먼저 놓아 보고 고르는 식물</div>
    </div>
    <div class="step-indicator" id="stepIndicator">
      <span class="step-dot"></span>
      <span>1 / 2 · 식물 선택</span>
    </div>
  </header>

  <!-- === 1. 식물 선택 화면 === -->
  <section class="screen screen-list active" id="screenList">
    <div class="intro-card">
      <div class="intro-title">어떤 식물을 공간에 놓아볼까요?</div>
      <div class="intro-desc">
        아래에서 식물을 고르면, 카메라를 켜서 <strong>우리 집 공간에 놓인 모습</strong>을 바로 확인할 수 있어요.
      </div>
      <div class="tag-row">
        <span class="tag highlight">실시간 미리보기</span>
        <span class="tag">크기 조절</span>
        <span class="tag">회전</span>
        <span class="tag">모바일 전용</span>
      </div>

      <div class="plant-grid" id="plantGrid"></div>

      <div class="bottom-helper">
        <span>
          <span class="dot-accent"></span>
          식물을 탭하면 카메라 화면으로 전환됩니다.
        </span>
        <span>두 손가락으로 크기 · 회전 조절</span>
      </div>
    </div>
  </section>

  <!-- === 2. 카메라 + 배치 화면 === -->
  <section class="screen screen-camera" id="screenCamera">
    <div class="camera-stage">
      <video id="camera" autoplay playsinline muted></video>

      <div id="plantWrapper" class="plant-wrapper">
        <img src="" alt="Plant" class="plant-image" id="plantImage" />
      </div>

      <div class="camera-overlay-gradient"></div>

      <div class="camera-controls">
        <div class="camera-info">
          <span>
            <span class="dot-accent"></span>
            손가락 한 개: 위치 이동 · 두 개: 크기/회전
          </span>
          <span id="plantNameLabel"></span>
        </div>

        <div class="camera-button-row">
          <button class="btn btn-secondary" id="backToListBtn">다른 식물 선택</button>
          <button class="btn btn-primary" id="readyBtn">촬영 준비 완료</button>
        </div>

        <!-- 크기/회전/초기화 컨트롤 -->
        <div class="size-controls">
          <div class="control-group">
            <button class="size-btn-small" id="smallerBtn">−</button>
            <span class="control-label">축소</span>
          </div>
          <div class="control-group">
            <button class="size-btn-small" id="biggerBtn">＋</button>
            <span class="control-label">확대</span>
          </div>
          <div class="control-group">
            <button class="size-btn-small" id="rotateBtn">↻</button>
            <span class="control-label">회전</span>
          </div>
          <div class="control-group">
            <button class="size-btn-small" id="resetBtn">초기화</button>
            <span class="control-label">초기화</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 토스트 메시지 -->
  <div id="toast" class="toast">준비중입니다.</div>

  <!-- 버전 표시 -->
  <div class="version-badge">v0.4.4</div>
</div>

<script>
  const screenList = document.getElementById('screenList');
  const screenCamera = document.getElementById('screenCamera');
  const stepIndicator = document.getElementById('stepIndicator');
  const plantGrid = document.getElementById('plantGrid');
  const plantImage = document.getElementById('plantImage');
  const plantNameLabel = document.getElementById('plantNameLabel');
  const backToListBtn = document.getElementById('backToListBtn');
  const readyBtn = document.getElementById('readyBtn');
  const toastEl = document.getElementById('toast');
  const cameraStage = document.querySelector('.camera-stage');
  const rotateBtn = document.getElementById('rotateBtn');
  const smallerBtn = document.getElementById('smallerBtn');
  const biggerBtn = document.getElementById('biggerBtn');
  const resetBtn = document.getElementById('resetBtn');

  let cameraStarted = false;
  let selectedPlant = null;
  let toastTimeout = null;

  const plants = [
    { id: 'plant_01', src: 'plant/plant_01.png', name: '플랜트 01', size: '대형' },
    { id: 'plant_02', src: 'plant/plant_02.png', name: '플랜트 02', size: '대형' },
    { id: 'plant_03', src: 'plant/plant_03.png', name: '플랜트 03', size: '대형' },
    { id: 'plant_04', src: 'plant/plant_04.png', name: '플랜트 04', size: '중형' },
    { id: 'plant_05', src: 'plant/plant_05.png', name: '플랜트 05', size: '소형' },
    { id: 'plant_06', src: 'plant/plant_06.png', name: '플랜트 06', size: '소형' }
  ];

  function renderPlantList() {
    plantGrid.innerHTML = '';
    plants.forEach((plant) => {
      const card = document.createElement('button');
      card.type = 'button';
      card.className = 'plant-card';
      card.dataset.plantId = plant.id;
      card.innerHTML = `
        <div class="plant-size-chip">${plant.size}</div>
        <img src="${plant.src}" alt="${plant.name}" class="plant-thumb" loading="lazy">
        <div class="plant-label">${plant.name}</div>
      `;
      card.addEventListener('click', () => onSelectPlant(plant));
      plantGrid.appendChild(card);
    });
  }

  function setStep(step) {
    if (step === 1) {
      stepIndicator.innerHTML = `
        <span class="step-dot"></span>
        <span>1 / 2 · 식물 선택</span>
      `;
    } else {
      stepIndicator.innerHTML = `
        <span class="step-dot"></span>
        <span>2 / 2 · 공간에 배치해 보기</span>
      `;
    }
  }

  function showListScreen() {
    screenCamera.classList.remove('active');
    screenList.classList.add('active');
    setStep(1);
  }

  function showCameraScreen() {
    screenList.classList.remove('active');
    screenCamera.classList.add('active');
    setStep(2);
  }

  function onSelectPlant(plant) {
    selectedPlant = plant;
    plantImage.src = plant.src;
    plantNameLabel.textContent = plant.name || '';
    resetPlantTransform();
    showCameraScreen();
    if (!cameraStarted) {
      startCamera();
      cameraStarted = true;
    }
  }

  backToListBtn.addEventListener('click', showListScreen);

  async function startCamera() {
    const videoEl = document.getElementById('camera');
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' } },
        audio: false
      });
      videoEl.srcObject = stream;
    } catch (err) {
      console.error('카메라 접근 실패:', err);
      alert('카메라를 사용할 수 없습니다. 권한을 허용했는지 확인해 주세요.');
    }
  }

  const plantWrapper = document.getElementById('plantWrapper');

  let currentX = 0;
  let currentY = 0;
  let currentScale = 1;
  let currentRotation = 0;

  let startX = 0;
  let startY = 0;
  let startScale = 1;
  let startRotation = 0;
  let startDistance = 0;
  let startAngle = 0;
  let lastTouchCount = 0;

  const COOLDOWN_MS = 500;
  let lastTouchEndTime = 0;

  function applyTransform() {
    plantWrapper.style.transform =
      `translate3d(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px), 0) ` +
      `scale(${currentScale}) rotate(${currentRotation}deg)`;
  }

  function resetPlantTransform() {
    currentX = 0;
    currentY = 0;
    currentScale = 1;
    currentRotation = 0;
    applyTransform();
  }

  function getDistance(t1, t2) {
    const dx = t2.clientX - t1.clientX;
    const dy = t2.clientY - t1.clientY;
    return Math.sqrt(dx * dx + dy * dy);
  }

  function getAngle(t1, t2) {
    const dx = t2.clientX - t1.clientX;
    const dy = t2.clientY - t1.clientY;
    return Math.atan2(dy, dx) * 180 / Math.PI;
  }

  cameraStage.addEventListener('touchstart', (e) => {
    if (e.target.closest('.camera-controls')) return;

    const now = Date.now();
    if (now - lastTouchEndTime < COOLDOWN_MS) {
      return;
    }

    e.preventDefault();

    const touchCount = e.touches.length;
    lastTouchCount = touchCount;

    if (touchCount === 1) {
      const t = e.touches[0];
      startX = t.clientX;
      startY = t.clientY;
    } else if (touchCount === 2) {
      const [t1, t2] = e.touches;
      startDistance = getDistance(t1, t2);
      startAngle = getAngle(t1, t2);
      startScale = currentScale;
      startRotation = currentRotation;
    }
  }, { passive: false });

  cameraStage.addEventListener('touchmove', (e) => {
    if (e.target.closest('.camera-controls')) return;

    const now = Date.now();
    if (now - lastTouchEndTime < COOLDOWN_MS) {
      return;
    }

    e.preventDefault();

    const touchCount = e.touches.length;

    if (touchCount !== lastTouchCount) {
      lastTouchCount = touchCount;
      if (touchCount === 1) {
        const t = e.touches[0];
        startX = t.clientX;
        startY = t.clientY;
      } else if (touchCount === 2) {
        const [t1, t2] = e.touches;
        startDistance = getDistance(t1, t2);
        startAngle = getAngle(t1, t2);
        startScale = currentScale;
        startRotation = currentRotation;
      }
      return;
    }

    if (touchCount === 1) {
      const t = e.touches[0];
      const dx = t.clientX - startX;
      const dy = t.clientY - startY;

      currentX += dx;
      currentY += dy;

      startX = t.clientX;
      startY = t.clientY;

      applyTransform();
    } else if (touchCount === 2) {
      const [t1, t2] = e.touches;
      const dist = getDistance(t1, t2);
      const angle = getAngle(t1, t2);

      const scaleFactor = dist / startDistance;
      currentScale = Math.max(0.2, Math.min(4, startScale * scaleFactor));

      const angleDelta = angle - startAngle;
      currentRotation = startRotation + angleDelta;

      applyTransform();
    }
  }, { passive: false });

  cameraStage.addEventListener('touchend', (e) => {
    if (e.target.closest('.camera-controls')) return;

    if (e.touches.length === 0) {
      lastTouchEndTime = Date.now();
      lastTouchCount = 0;
    } else {
      lastTouchCount = e.touches.length;
    }
  }, { passive: false });

  // 길게 누르면 조금씩 / 단일 탭은 크게 변경하는 버튼 세팅
  function setupHoldButton(button, bigStepFn, smallStepFn) {
    let delayTimer = null;
    let repeatTimer = null;
    let holding = false;

    const clearTimers = () => {
      if (delayTimer) {
        clearTimeout(delayTimer);
        delayTimer = null;
      }
      if (repeatTimer) {
        clearInterval(repeatTimer);
        repeatTimer = null;
      }
    };

    const start = (e) => {
      e.preventDefault();
      clearTimers();
      holding = false;

      delayTimer = setTimeout(() => {
        holding = true;
        smallStepFn();
        repeatTimer = setInterval(smallStepFn, 80);
      }, 220);
    };

    const end = () => {
      const wasHolding = holding;
      clearTimers();
      holding = false;
      if (!wasHolding) {
        bigStepFn();
      }
    };

    button.addEventListener('mousedown', start);
    button.addEventListener('touchstart', start, { passive: false });
    ['mouseup', 'mouseleave'].forEach(ev => button.addEventListener(ev, end));
    ['touchend', 'touchcancel'].forEach(ev => button.addEventListener(ev, end));
  }

  setupHoldButton(
    smallerBtn,
    () => {
      currentScale = Math.max(0.2, currentScale - 0.15);
      applyTransform();
    },
    () => {
      currentScale = Math.max(0.2, currentScale - 0.02);
      applyTransform();
    }
  );

  setupHoldButton(
    biggerBtn,
    () => {
      currentScale = Math.min(4, currentScale + 0.15);
      applyTransform();
    },
    () => {
      currentScale = Math.min(4, currentScale + 0.02);
      applyTransform();
    }
  );

  // 회전 버튼: 시계 방향(+90도)
  rotateBtn.addEventListener('click', () => {
    currentRotation += 90;
    applyTransform();
  });

  // 초기화 버튼
  resetBtn.addEventListener('click', () => {
    resetPlantTransform();
  });

  function showToast(message) {
    if (!toastEl) return;
    toastEl.textContent = message || '준비중입니다.';
    toastEl.classList.add('active');
    if (toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => {
      toastEl.classList.remove('active');
    }, 1500);
  }

  readyBtn.addEventListener('click', () => {
    showToast('준비중입니다.');
  });

  renderPlantList();
  resetPlantTransform();
  setStep(1);
</script>
</body>
</html>