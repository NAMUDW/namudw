<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë‚˜ë¬´ë‹¤ìš´ - ê³µê°„ ë°°ì¹˜ ë¯¸ë¦¬ë³´ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-dark: #050509;
      --bg-card: rgba(10, 10, 20, 0.92);
      --accent: #4ade80;
      --accent-soft: rgba(74, 222, 128, 0.18);
      --text-main: #f9fafb;
      --text-sub: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.25);
      
      /* ê·¸ë¦¼ì íˆ¬ëª…ë„ */
      --shadow-opacity: 0.6; 
    }

    html, body { touch-action: none; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 50%, #000 100%);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
    }

    .app {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    /* ê³µí†µ ìƒë‹¨ í—¤ë” */
    .app-header {
      position: absolute;
      top: calc(env(safe-area-inset-top, 0) + 24px);
      left: 0;
      right: 0;
      z-index: 20;
      padding: 12px 18px 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      pointer-events: none;
    }

    .app-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
      pointer-events: auto;
    }

    .app-logo-img {
      height: 22px;
      width: auto;
      display: block;
    }

    .app-title-sub {
      font-size: 11px;
      color: #ffffff;
      opacity: 0.9;
      letter-spacing: -0.01em;
    }

    .step-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border-subtle);
      font-size: 11px;
      color: var(--text-sub);
      pointer-events: auto;
      white-space: nowrap;
    }

    .step-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-soft);
    }

    /* í™”ë©´ ì „í™˜ìš© ë ˆì´ì•„ì›ƒ */
    .screen {
      position: absolute;
      inset: 0;
      padding: calc(90px + env(safe-area-inset-top, 0)) 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      opacity: 0;
      pointer-events: none;
      transform: translateX(12px);
      transition: opacity 0.35s ease, transform 0.35s ease;
      
      /* â˜… [PC ìˆ˜ì •] ìŠ¤í¬ë¡¤ í—ˆìš© */
      overflow-y: auto; 
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }

    /* ì¹´ë©”ë¼ëŠ” ìŠ¤í¬ë¡¤ ë§‰ìŒ */
    .screen-camera {
      overflow: hidden;
      padding: 0;
    }

    .screen.active {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(0);
    }

    /* ===== ì‹ë¬¼ ì„ íƒ í™”ë©´ ===== */
    .screen-list { background: transparent; }

    .intro-card {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 14px 14px 12px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.7);
      /* ì»¨í…ì¸ ê°€ ë§ìœ¼ë©´ ì¹´ë“œê°€ ëŠ˜ì–´ë‚˜ê³  í™”ë©´ì´ ìŠ¤í¬ë¡¤ë¨ */
      margin-bottom: 40px; 
    }

    .intro-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .intro-desc {
      font-size: 12px;
      color: var(--text-sub);
      line-height: 1.4;
    }

    /* í¬ê¸° íƒ­ */
    .size-tabs {
      display: inline-flex;
      margin-top: 10px;
      padding: 3px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(51,65,85,0.9);
      gap: 4px;
    }

    .size-tab {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      color: var(--text-sub);
      background: transparent;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
    }

    .size-tab.active {
      background: linear-gradient(135deg,#22c55e,#4ade80);
      color: #022c22;
      font-weight: 600;
    }

    .plant-grid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      padding-bottom: 8px;
    }

    .plant-card {
      position: relative;
      border-radius: 14px;
      overflow: hidden;
      background: radial-gradient(circle at top, #f9fafb 0, #e5e7eb 40%, #d1d5db 100%);
      border: 1px solid rgba(209, 213, 219, 0.9);
      padding: 6px 6px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      min-height: 112px;
      cursor: pointer;
      touch-action: manipulation;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease, background 0.12s ease;
    }

    .plant-card:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.45);
      border-color: var(--accent);
      background: radial-gradient(circle at top, #fefce8 0, #e5e7eb 45%, #d1d5db 100%);
    }

    .plant-thumb {
      width: 100%;
      aspect-ratio: 3 / 4;
      object-fit: contain;
      filter: drop-shadow(0 6px 10px rgba(15, 23, 42, 0.45));
      pointer-events: none;
    }

    .plant-label {
      margin-top: 4px;
      font-size: 11px;
      color: #4b5563;
      text-align: center;
    }

    .plant-size-chip {
      position: absolute;
      left: 6px;
      top: 6px;
      font-size: 10px;
      padding: 3px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--text-sub);
    }

    .bottom-helper {
      margin-top: auto;
      font-size: 11px;
      color: var(--text-sub);
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      padding: 0 2px 4px;
    }

    .bottom-helper span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .dot-accent {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: var(--accent);
    }

    /* ===== ì¹´ë©”ë¼ í™”ë©´ ===== */

    .camera-stage {
      position: relative;
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden;
      touch-action: none;
      cursor: grab; /* PCì—ì„œ ë§ˆìš°ìŠ¤ ì»¤ì„œ */
    }
    
    .camera-stage:active {
      cursor: grabbing;
    }

    video {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
      top: 0;
      left: 0;
      background: #000;
      z-index: 1;
    }

    .bg-image {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      background: #000;
      display: none;
      z-index: 1;
      object-fit: contain; 
    }

    .plant-wrapper {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate3d(-50%, -50%, 0) scale(1) rotate(0deg);
      z-index: 10;
      pointer-events: none; /* í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ìŠ¤í…Œì´ì§€ë¡œ í†µê³¼ì‹œí‚´ */
    }

    .plant-wrapper-inner {
      position: relative;
      width: 45vw;
      max-width: 45vw;
      height: auto;
    }

    .plant-image {
      width: 100%;
      height: auto;
      user-select: none;
      pointer-events: none;
      display: block;
    }

    #plantShadow {
      position: absolute;
      top: 0;
      left: 0;
      filter: drop-shadow(0 16px 30px rgba(0, 0, 0, var(--shadow-opacity)));
      z-index: 1;
    }

    #plantMain {
      position: relative;
      z-index: 2;
    }

    .camera-overlay-gradient {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at bottom, rgba(0,0,0,0.65) 0, transparent 50%),
                  linear-gradient(to top, rgba(15,23,42,0.9), transparent 35%);
      z-index: 12;
    }

    .camera-controls {
      position: absolute;
      left: 0;
      right: 0;
      bottom: max(40px, calc(env(safe-area-inset-bottom, 0) + 32px));
      padding: 0 16px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 20;
      pointer-events: auto;
    }

    .camera-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-sub);
      padding: 4px 4px 0;
      gap: 8px;
    }

    .camera-info-main {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      max-width: 75%;
    }

    .finger-icon {
      font-size: 14px;
      filter: grayscale(1) brightness(2);
    }

    .camera-info-text {
      line-height: 1.3;
    }

    .camera-info span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    /* ë²„íŠ¼ ì¤„ */
    .camera-button-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 4px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      background: rgba(15, 23, 42, 0.90);
      color: var(--text-main);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border-subtle);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
      cursor: pointer;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #4ade80);
      border-color: rgba(74, 222, 128, 0.7);
      color: #022c22;
      font-weight: 600;
      box-shadow: 0 8px 22px rgba(22, 163, 74, 0.55);
      min-width: 88px;
      justify-content: center;
    }

    #captureBtn {
      height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-secondary {
      padding-inline: 12px;
      font-size: 12px;
      color: var(--text-sub);
      background: rgba(15, 23, 42, 0.9);
    }

    .size-controls {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      justify-content: center;
      margin-top: 8px;
      flex-wrap: nowrap;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .control-label {
      font-size: 10px;
      color: var(--text-sub);
      white-space: nowrap;
    }

    .size-btn-small {
      border-radius: 999px;
      width: 40px;
      height: 40px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: #e5e7eb;
      font-size: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.8);
      cursor: pointer;
    }

    #resetBtn.size-btn-small,
    #changePlantBtn.size-btn-small {
      font-size: 11px;
      padding: 0 10px;
      width: auto;
      min-width: 64px;
    }

    .size-btn-small:active {
      transform: translateY(1px) scale(0.96);
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.9);
    }

    /* ===== ìŠ¬ë¼ì´ë” ===== */
    .depth-slider {
      flex: 0 0 auto;
      display: flex;
      justify-content: center;
    }

    .depth-track {
      position: relative;
      width: 260px;
      max-width: 260px;
      height: 44px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #111827 0, #020617 60%);
      box-shadow:
        0 14px 30px rgba(0, 0, 0, 0.85),
        inset 0 0 0 1px rgba(148, 163, 184, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      padding: 0 22px;
      cursor: pointer;
    }

    .depth-label {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 11px;
      color: #e5e7eb;
      pointer-events: none;
      opacity: 0.85;
    }

    .depth-label-left { left: 14px; text-align: left; }
    .depth-label-right { right: 14px; text-align: right; }

    .depth-thumb {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: #e5e7eb;
      box-shadow:
        0 8px 18px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #111827;
      touch-action: none;
      cursor: grab;
    }
    
    .depth-thumb:active {
      cursor: grabbing;
    }

    .depth-icon-svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
      display: block;
    }

    /* í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed;
      left: 50%;
      bottom: max(120px, calc(32px + env(safe-area-inset-bottom, 0)));
      transform: translateX(-50%);
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border-subtle);
      color: var(--text-main);
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease, transform 0.25s ease;
      z-index: 40;
    }

    .toast.active {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    /* ìº¡ì²˜ ê²°ê³¼ */
    .capture-result {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.96);
      display: none;
      align-items: flex-start;
      justify-content: center;
      padding: calc(env(safe-area-inset-top, 0) + 40px) 16px calc(env(safe-area-inset-bottom, 0) + 40px);
      z-index: 60;
      overflow-y: auto;
    }

    .capture-result.active {
      display: flex;
    }

    .capture-card {
      width: 100%;
      max-width: 420px;
      background: rgba(15, 23, 42, 0.98);
      border-radius: 20px;
      padding: 18px 14px 16px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .capture-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .capture-close {
      border: none;
      background: rgba(239, 68, 68, 0.18);
      color: #fecaca;
      font-size: 22px;
      padding: 0;
      border-radius: 999px;
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(248, 113, 113, 0.9);
      box-shadow: 0 6px 16px rgba(127, 29, 29, 0.7);
      cursor: pointer;
    }

    .capture-preview {
      width: 100%;
      border-radius: 16px;
      overflow: hidden;
      background: #000;
      border: 1px solid rgba(31, 41, 55, 0.9);
      text-align: center;
    }

    .capture-preview img {
      max-width: 100%;
      max-height: 80vh;
      height: auto;
      display: inline-block;
    }

    .capture-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
    }

    .capture-actions-main {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .capture-actions-main .btn {
      flex: 1;
      justify-content: center;
      min-width: auto;
      padding-inline: 8px;
    }

    .btn-kakao {
      background: #fee500;
      color: #111827;
      border-color: #eab308;
      font-weight: 600;
    }

    .btn-outline {
      background: transparent;
      color: #e5e7eb;
      border-color: rgba(148, 163, 184, 0.9);
    }

    .btn-share {
      background: rgba(55, 65, 81, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: #e5e7eb;
      flex: 0 0 auto !important; 
      width: 44px;
      padding: 0;
      font-size: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .capture-note { font-size: 11px; color: #9ca3af; }

    /* ëª¨ë“œ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ */
    .mode-dialog-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 55;
      padding: 0 12px calc(env(safe-area-inset-bottom, 0) + 16px);
      backdrop-filter: blur(2px);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .mode-dialog-backdrop.active { display: flex; opacity: 1; }

    .mode-dialog {
      width: 100%;
      max-width: 420px;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 18px;
      padding: 20px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.9);
      transform: translateY(20px);
      transition: transform 0.2s ease;
    }

    .mode-dialog-backdrop.active .mode-dialog { transform: translateY(0); }

    .mode-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 6px;
      color: var(--text-main);
    }

    .mode-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 16px;
      line-height: 1.4;
    }

    .mode-actions { display: flex; flex-direction: column; gap: 8px; }

    .mode-row { display: flex; gap: 10px; }

    .btn-mode {
      flex: 1;
      padding: 12px 0;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-mode-secondary {
      background: rgba(30, 41, 59, 0.8);
      color: #e5e7eb;
      border: 1px solid rgba(75,85,99,0.5);
    }

    .mode-cancel { margin-top: 8px; text-align: center; }
    .mode-cancel button {
      border: none;
      background: transparent;
      color: #64748b;
      font-size: 12px;
      padding: 8px;
      text-decoration: underline;
      cursor: pointer;
    }

    .version-badge {
      position: fixed;
      right: 8px;
      bottom: calc(env(safe-area-inset-bottom, 0) + 4px);
      font-size: 10px;
      color: rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.8);
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(55, 65, 81, 0.8);
      z-index: 50;
      pointer-events: none;
    }

    .no-select {
      user-select: none;
      -webkit-user-select: none;
    }
  </style>
</head>
<body>
<div class="app no-select">
  <header class="app-header">
    <div class="app-title">
      <div class="app-title-main">
        <img src="logo.svg" alt="ë‚˜ë¬´ë‹¤ìš´" class="app-logo-img" id="headerLogo" />
      </div>
      <div class="app-title-sub">ê³µê°„ì— ë¨¼ì € ë†“ì•„ ë³´ê³  ê³ ë¥´ëŠ” ì‹ë¬¼</div>
    </div>
    <div class="step-indicator" id="stepIndicator">
      <span class="step-dot"></span>
      <span>1 / 3 Â· ì‹ë¬¼ ì„ íƒ</span>
    </div>
  </header>

  <section class="screen screen-list active" id="screenList">
    <div class="intro-card">
      <div class="intro-title">ì–´ë–¤ ì‹ë¬¼ì„ ê³µê°„ì— ë†“ì•„ë³¼ê¹Œìš”?</div>
      <div class="intro-desc">
        ì•„ë˜ì—ì„œ ì‹ë¬¼ì„ ê³ ë¥´ë©´, ì¹´ë©”ë¼ë¥¼ ì¼œì„œ <strong>ìš°ë¦¬ ì§‘ ê³µê°„ì— ë†“ì¸ ëª¨ìŠµ</strong>ì„ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.
      </div>

      <div class="size-tabs" id="sizeTabs">
        <button class="size-tab active" data-size="ALL">ì „ì²´</button>
        <button class="size-tab" data-size="ëŒ€í˜•">ëŒ€í˜•</button>
        <button class="size-tab" data-size="ì¤‘í˜•">ì¤‘í˜•</button>
        <button class="size-tab" data-size="ì†Œí˜•">ì†Œí˜•</button>
      </div>

      <div class="plant-grid" id="plantGrid"></div>

      <div class="bottom-helper">
        <span>
          <span class="dot-accent"></span>
          ì‹ë¬¼ì„ íƒ­í•˜ë©´ ëª¨ë“œ ì„ íƒ í›„ ì¹´ë©”ë¼ í™”ë©´ìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤.
        </span>
      </div>
    </div>
  </section>

  <section class="screen screen-camera" id="screenCamera">
    <div class="camera-stage">
      <video id="camera" autoplay playsinline muted></video>
      <img id="bgImage" class="bg-image" alt="Background" />

      <div id="plantWrapper" class="plant-wrapper">
        <div class="plant-wrapper-inner">
          <img src="" alt="Plant shadow" class="plant-image" id="plantShadow" />
          <img src="" alt="Plant main"   class="plant-image" id="plantMain" />
        </div>
      </div>

      <div class="camera-overlay-gradient"></div>

      <div class="camera-controls">
        <div class="camera-info">
          <span class="camera-info-main">
            <span class="finger-icon">ğŸ‘†</span>
            <span class="camera-info-text">
              í™”ë©´ ì† ì‹ë¬¼ì„ ì†ê°€ë½ìœ¼ë¡œ<br>ì›í•˜ëŠ” ìœ„ì¹˜ë¡œ ì˜®ê²¨ ë³´ì„¸ìš”.
            </span>
          </span>
          <span id="plantNameLabel"></span>
        </div>

        <div class="camera-button-row">
          <div class="depth-slider">
            <div class="depth-track" id="depthTrack">
              <div class="depth-thumb" id="depthThumb">
                <svg class="depth-icon-svg" viewBox="0 0 24 24">
                  <path d="M17.5858 5H14V3H21V10H19V6.41421L14.7071 10.7071L13.2929 9.29289L17.5858 5ZM3 14H5V17.5858L9.29289 13.2929L10.7071 14.7071L6.41421 19H10V21H3V14Z" />
                </svg>
              </div>
              <span class="depth-label depth-label-left">ì¶•ì†Œ</span>
              <span class="depth-label depth-label-right">í™•ëŒ€</span>
            </div>
          </div>
          <button class="btn btn-primary" id="captureBtn">ì´¬ì˜</button>
        </div>

        <div class="size-controls">
          <div class="control-group">
            <button class="size-btn-small" id="smallerBtn">âˆ’</button>
            <span class="control-label">ì¶•ì†Œ</span>
          </div>
          <div class="control-group">
            <button class="size-btn-small" id="biggerBtn">ï¼‹</button>
            <span class="control-label">í™•ëŒ€</span>
          </div>
          <div class="control-group">
            <button class="size-btn-small" id="rotateBtn">â†»</button>
            <span class="control-label">íšŒì „</span>
          </div>
          <div class="control-group">
            <button class="size-btn-small" id="resetBtn">ì´ˆê¸°í™”</button>
            <span class="control-label">ì´ˆê¸°í™”</span>
          </div>
          <div class="control-group">
            <button class="size-btn-small" id="changePlantBtn">ë‹¤ë¥¸ ì‹ë¬¼</button>
            <span class="control-label">ë‹¤ë¥¸ ì‹ë¬¼</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div id="toast" class="toast">ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.</div>
  <canvas id="captureCanvas" style="display:none;"></canvas>

  <div class="capture-result" id="captureResult">
    <div class="capture-card">
      <div class="capture-header">
        <div class="step-indicator">
          <span class="step-dot"></span>
          <span>3 / 3 Â· ì´¬ì˜ ê²°ê³¼</span>
        </div>
        <button class="capture-close" id="captureCloseBtn" aria-label="ë‹«ê¸°">Ã—</button>
      </div>
      
      <div style="padding: 0 4px 8px;">
        <small style="font-size:11px; color:#9ca3af;">ì§€ê¸ˆ í™”ë©´ ê·¸ëŒ€ë¡œ ì €ì¥í•˜ê±°ë‚˜ ê³µìœ í•  ìˆ˜ ìˆì–´ìš”.</small>
      </div>

      <div class="capture-preview">
        <img id="capturedImage" src="" alt="Captured plant preview" />
      </div>
      
      <div class="capture-actions">
        <div class="capture-actions-main">
          <a class="btn btn-kakao" href="#" target="_blank">ì¹´ì¹´ì˜¤í†¡ ë¬¸ì˜</a>
          <a class="btn btn-outline" href="#" target="_blank">ì‹ë¬¼ êµ¬ì…</a>
          <button class="btn btn-share" id="shareBtn" aria-label="ê³µìœ í•˜ê¸°">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="18" cy="5" r="3"></circle>
              <circle cx="6" cy="12" r="3"></circle>
              <circle cx="18" cy="19" r="3"></circle>
              <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
              <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
            </svg>
          </button>
        </div>
        <div class="capture-note">
          ì´ë¯¸ì§€ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ ì‚¬ì§„ì²©ì— ì €ì¥í•˜ê±°ë‚˜, ìº¡ì²˜ í™”ë©´ì„ ë°”ë¡œ ê³µìœ í•´ ë³´ì„¸ìš”.
        </div>
      </div>
    </div>
  </div>

  <div class="mode-dialog-backdrop" id="modeDialog">
    <div class="mode-dialog">
      <div class="mode-title">ì–´ë–»ê²Œ ë°°ì¹˜í•´ ë³¼ê¹Œìš”?</div>
      <div class="mode-sub">ì‹¤ì‹œê°„ ì¹´ë©”ë¼ë¥¼ ì¼œê±°ë‚˜, ì´ë¯¸ ì°ì–´ ë‘” ì‚¬ì§„ ìœ„ì— ì‹ë¬¼ì„ ì˜¬ë ¤ë‘˜ ìˆ˜ ìˆì–´ìš”.</div>
      <div class="mode-actions">
        <div class="mode-row">
          <button class="btn btn-primary btn-mode" id="modeLiveBtn">ğŸ“· ì‹¤ì‹œê°„ ì´¬ì˜</button>
          <button class="btn btn-mode btn-mode-secondary" id="modeImageBtn">ğŸ–¼ï¸ ê¸°ì¡´ ì´ë¯¸ì§€</button>
        </div>
        <div class="mode-cancel">
          <button type="button" id="modeCancelBtn">ì„ íƒ ì·¨ì†Œ</button>
        </div>
      </div>
    </div>
  </div>

  <input type="file" accept="image/*" id="bgFileInput" style="display:none;" />
  <div class="version-badge">v0.9.2</div>
</div>

<script>
  window.SHADOW_OPACITY = 0.6;
  document.documentElement.style.setProperty('--shadow-opacity', window.SHADOW_OPACITY);

  window.PLANT_GESTURE_ENABLED = false;
  if (typeof window.CAPTURE_PREVIEW_SCALE !== 'number') {
    window.CAPTURE_PREVIEW_SCALE = 0.6;
  }

  const screenList = document.getElementById('screenList');
  const screenCamera = document.getElementById('screenCamera');
  const stepIndicator = document.getElementById('stepIndicator');
  const plantGrid = document.getElementById('plantGrid');
  const sizeTabs = document.getElementById('sizeTabs');
  
  const modeDialog = document.getElementById('modeDialog');
  const modeLiveBtn = document.getElementById('modeLiveBtn');
  const modeImageBtn = document.getElementById('modeImageBtn');
  const modeCancelBtn = document.getElementById('modeCancelBtn');
  const bgFileInput = document.getElementById('bgFileInput');
  
  const cameraVideo = document.getElementById('camera');
  const bgImage = document.getElementById('bgImage');
  const headerLogo = document.getElementById('headerLogo');

  const plantShadow = document.getElementById('plantShadow');
  const plantMain   = document.getElementById('plantMain');
  const plantNameLabel = document.getElementById('plantNameLabel');
  const captureBtn = document.getElementById('captureBtn');
  const shareBtn = document.getElementById('shareBtn');
  const toastEl = document.getElementById('toast');
  const cameraStage = document.querySelector('.camera-stage');
  const rotateBtn = document.getElementById('rotateBtn');
  const smallerBtn = document.getElementById('smallerBtn');
  const biggerBtn = document.getElementById('biggerBtn');
  const resetBtn = document.getElementById('resetBtn');
  const changePlantBtn = document.getElementById('changePlantBtn');
  const depthTrack = document.getElementById('depthTrack');
  const depthThumb = document.getElementById('depthThumb');
  const captureCanvas = document.getElementById('captureCanvas');
  const captureResult = document.getElementById('captureResult');
  const capturedImage = document.getElementById('capturedImage');
  const captureCloseBtn = document.getElementById('captureCloseBtn');

  let isCameraMode = true;
  let cameraStream = null;
  let selectedPlant = null;
  let toastTimeout = null;
  let currentSizeFilter = 'ALL';

  const plants = [
    { id: 'plant_01', src: 'plant/plant_01.png', name: 'í”ŒëœíŠ¸ 01', size: 'ëŒ€í˜•' },
    { id: 'plant_02', src: 'plant/plant_02.png', name: 'í”ŒëœíŠ¸ 02', size: 'ëŒ€í˜•' },
    { id: 'plant_03', src: 'plant/plant_03.png', name: 'í”ŒëœíŠ¸ 03', size: 'ëŒ€í˜•' },
    { id: 'plant_04', src: 'plant/plant_04.png', name: 'í”ŒëœíŠ¸ 04', size: 'ì¤‘í˜•' },
    { id: 'plant_05', src: 'plant/plant_05.png', name: 'í”ŒëœíŠ¸ 05', size: 'ì†Œí˜•' },
    { id: 'plant_06', src: 'plant/plant_06.png', name: 'í”ŒëœíŠ¸ 06', size: 'ì†Œí˜•' }
  ];

  function renderPlantList() {
    plantGrid.innerHTML = '';
    plants
      .filter(p => currentSizeFilter === 'ALL' || p.size === currentSizeFilter)
      .forEach((plant) => {
        const card = document.createElement('button');
        card.type = 'button';
        card.className = 'plant-card';
        card.dataset.plantId = plant.id;
        card.innerHTML = `
          <div class="plant-size-chip">${plant.size}</div>
          <img src="${plant.src}" alt="${plant.name}" class="plant-thumb" loading="lazy">
          <div class="plant-label">${plant.name}</div>
        `;
        card.addEventListener('click', () => onSelectPlant(plant));
        plantGrid.appendChild(card);
      });
  }

  sizeTabs.querySelectorAll('.size-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      sizeTabs.querySelectorAll('.size-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentSizeFilter = tab.dataset.size || 'ALL';
      renderPlantList();
    });
  });

  function setStep(step) {
    if (step === 1) {
      stepIndicator.innerHTML = `<span class="step-dot"></span><span>1 / 3 Â· ì‹ë¬¼ ì„ íƒ</span>`;
    } else if (step === 2) {
      stepIndicator.innerHTML = `<span class="step-dot"></span><span>2 / 3 Â· ê³µê°„ì— ë°°ì¹˜í•´ ë³´ê¸°</span>`;
    } else if (step === 3) {
      stepIndicator.innerHTML = `<span class="step-dot"></span><span>3 / 3 Â· ê²°ê³¼ í™•ì¸ ë° ê³µìœ </span>`;
    }
  }

  function onSelectPlant(plant) {
    selectedPlant = plant;
    plantShadow.src = plant.src;
    plantMain.src   = plant.src;
    plantNameLabel.textContent = plant.name || '';
    modeDialog.classList.add('active');
  }

  modeCancelBtn.addEventListener('click', () => {
    modeDialog.classList.remove('active');
    selectedPlant = null;
  });

  modeLiveBtn.addEventListener('click', () => {
    modeDialog.classList.remove('active');
    isCameraMode = true;
    cameraVideo.style.display = 'block';
    bgImage.style.display = 'none';
    resetPlantTransformAndSlider();
    showCameraScreen();
    startCamera();
  });

  modeImageBtn.addEventListener('click', () => {
    bgFileInput.click();
  });

  bgFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
      bgImage.src = ev.target.result;
      isCameraMode = false;
      modeDialog.classList.remove('active');
      cameraVideo.style.display = 'none';
      bgImage.style.display = 'block';
      stopCamera();
      resetPlantTransformAndSlider();
      showCameraScreen();
    };
    reader.readAsDataURL(file);
    bgFileInput.value = '';
  });

  function showListScreen() {
    screenCamera.classList.remove('active');
    screenList.classList.add('active');
    stopCamera(); 
    setStep(1);
  }

  function showCameraScreen() {
    screenList.classList.remove('active');
    screenCamera.classList.add('active');
    setStep(2);
  }

  changePlantBtn.addEventListener('click', showListScreen);

  async function startCamera() {
    if (cameraStream) return;
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' } },
        audio: false
      });
      cameraStream = stream;
      cameraVideo.srcObject = stream;
    } catch (err) {
      console.error('ì¹´ë©”ë¼ ê¶Œí•œ ì—ëŸ¬:', err);
    }
  }

  function stopCamera() {
    if (cameraStream) {
      cameraStream.getTracks().forEach(track => track.stop());
      cameraStream = null;
      cameraVideo.srcObject = null;
    }
  }

  const plantWrapper = document.getElementById('plantWrapper');
  let gestureScale = 1;
  let sliderRatio = 0.5;
  let sliderScale = 1;
  let currentX = 0, currentY = 0, currentRotation = 0;
  
  let dragStartX = 0, dragStartY = 0, dragBaseX = 0, dragBaseY = 0;
  let pinchStartDist = 0, pinchStartAngle = 0, pinchBaseScale = 1, pinchBaseRot = 0;
  let lastTouchCount = 0;

  function recomputeSliderScale() {
    const offset = (sliderRatio - 0.5) * 2; 
    const factor = 1 + offset * 0.6;        
    sliderScale = Math.max(0.4, Math.min(1.6, factor));
  }

  function applyTransform() {
    const effectiveScale = gestureScale * sliderScale;
    plantWrapper.style.transform =
      `translate3d(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px), 0) ` +
      `scale(${effectiveScale}) rotate(${currentRotation}deg)`;
  }

  function resetPlantTransformAndSlider() {
    currentX = 0; currentY = 0; currentRotation = 0;
    gestureScale = 1; sliderRatio = 0.5;
    recomputeSliderScale();
    applyTransform();
    updateSliderThumbPosition();
  }

  function getDistance(t1, t2) {
    const dx = t2.clientX - t1.clientX;
    const dy = t2.clientY - t1.clientY;
    return Math.sqrt(dx*dx + dy*dy);
  }
  function getAngle(t1, t2) {
    const dx = t2.clientX - t1.clientX;
    const dy = t2.clientY - t1.clientY;
    return Math.atan2(dy, dx) * 180 / Math.PI;
  }

  cameraStage.addEventListener('touchstart', (e) => {
    if (e.target.closest('.camera-controls')) return;
    e.preventDefault();
    const tc = e.touches.length;
    lastTouchCount = tc;
    if (tc === 1) {
      dragStartX = e.touches[0].clientX;
      dragStartY = e.touches[0].clientY;
      dragBaseX = currentX;
      dragBaseY = currentY;
    } else if (tc === 2 && window.PLANT_GESTURE_ENABLED) {
      pinchStartDist = getDistance(e.touches[0], e.touches[1]);
      pinchStartAngle = getAngle(e.touches[0], e.touches[1]);
      pinchBaseScale = gestureScale;
      pinchBaseRot = currentRotation;
    }
  }, {passive: false});

  cameraStage.addEventListener('touchmove', (e) => {
    if (e.target.closest('.camera-controls')) return;
    e.preventDefault();
    const tc = e.touches.length;
    if (tc !== lastTouchCount) {
      lastTouchCount = tc;
      if (tc === 1) {
        dragStartX = e.touches[0].clientX;
        dragStartY = e.touches[0].clientY;
        dragBaseX = currentX;
        dragBaseY = currentY;
      } else if (tc === 2 && window.PLANT_GESTURE_ENABLED) {
        pinchStartDist = getDistance(e.touches[0], e.touches[1]);
        pinchStartAngle = getAngle(e.touches[0], e.touches[1]);
        gestureScale = Math.max(0.2, Math.min(4, pinchBaseScale * (dist / pinchStartDist)));
        currentRotation = pinchBaseRot + (angle - pinchStartAngle);
        applyTransform();
      }
      return;
    }

    if (tc === 1) {
      currentX = dragBaseX + (e.touches[0].clientX - dragStartX);
      currentY = dragBaseY + (e.touches[0].clientY - dragStartY);
      applyTransform();
    } else if (tc === 2 && window.PLANT_GESTURE_ENABLED) {
      const dist = getDistance(e.touches[0], e.touches[1]);
      const angle = getAngle(e.touches[0], e.touches[1]);
      gestureScale = Math.max(0.2, Math.min(4, pinchBaseScale * (dist / pinchStartDist)));
      currentRotation = pinchBaseRot + (angle - pinchStartAngle);
      applyTransform();
    }
  }, {passive: false});

  cameraStage.addEventListener('touchend', (e) => {
    if (e.target.closest('.camera-controls')) return;
    lastTouchCount = e.touches.length;
  });

  // [PC] ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ ê¸°ëŠ¥
  let isMouseDown = false;
  let mouseStartX = 0;
  let mouseStartY = 0;
  let mouseBaseX = 0;
  let mouseBaseY = 0;

  cameraStage.addEventListener('mousedown', (e) => {
    if (e.target.closest('.camera-controls')) return;
    e.preventDefault();
    isMouseDown = true;
    mouseStartX = e.clientX;
    mouseStartY = e.clientY;
    mouseBaseX = currentX;
    mouseBaseY = currentY;
  });

  window.addEventListener('mousemove', (e) => {
    if (!isMouseDown) return;
    e.preventDefault();
    const dx = e.clientX - mouseStartX;
    const dy = e.clientY - mouseStartY;
    currentX = mouseBaseX + dx;
    currentY = mouseBaseY + dy;
    applyTransform();
  });

  window.addEventListener('mouseup', () => {
    isMouseDown = false;
  });

  function setupHoldButton(btn, bigFn, smallFn) {
    let t1, t2, holding=false;
    const clear = () => { clearTimeout(t1); clearInterval(t2); t1=null; t2=null; };
    const start = (e) => {
      e.preventDefault(); clear(); holding=false;
      t1 = setTimeout(() => { holding=true; smallFn(); t2 = setInterval(smallFn, 80); }, 220);
    };
    const end = () => {
      const was = holding; clear(); holding=false;
      if (!was) bigFn();
    };
    btn.addEventListener('mousedown', start);
    btn.addEventListener('touchstart', start, {passive:false});
    ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev => btn.addEventListener(ev, end));
  }

  setupHoldButton(smallerBtn, 
    () => { gestureScale = Math.max(0.2, gestureScale - 0.15); applyTransform(); },
    () => { gestureScale = Math.max(0.2, gestureScale - 0.02); applyTransform(); }
  );
  setupHoldButton(biggerBtn, 
    () => { gestureScale = Math.min(4, gestureScale + 0.15); applyTransform(); },
    () => { gestureScale = Math.min(4, gestureScale + 0.02); applyTransform(); }
  );

  rotateBtn.addEventListener('click', () => { currentRotation += 90; applyTransform(); });
  resetBtn.addEventListener('click', resetPlantTransformAndSlider);

  function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add('active');
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => toastEl.classList.remove('active'), 1500);
  }

  // ===== ìº¡ì²˜ ê¸°ëŠ¥ =====
  captureBtn.addEventListener('click', () => {
    const stageRect = cameraStage.getBoundingClientRect();
    const plantInner = document.querySelector('.plant-wrapper-inner');
    if (!plantInner) return;

    captureCanvas.width = stageRect.width;
    captureCanvas.height = stageRect.height;
    const ctx = captureCanvas.getContext('2d');

    // 1. ë°°ê²½ ê·¸ë¦¬ê¸°
    if (isCameraMode) {
      if (cameraVideo && cameraVideo.videoWidth > 0) {
        drawObjectFitCover(ctx, cameraVideo, captureCanvas.width, captureCanvas.height);
      }
    } else {
      if (bgImage && bgImage.naturalWidth > 0) {
        drawObjectFitContain(ctx, bgImage, captureCanvas.width, captureCanvas.height);
      }
    }

    // 2. ì‹ë¬¼ ê·¸ë¦¬ê¸°
    const plantRect = plantInner.getBoundingClientRect();
    const scaleX = captureCanvas.width / stageRect.width;
    const scaleY = captureCanvas.height / stageRect.height;
    
    const centerX = (plantRect.left - stageRect.left + plantRect.width/2) * scaleX;
    const centerY = (plantRect.top - stageRect.top + plantRect.height/2) * scaleY;
    
    const effScale = gestureScale * sliderScale;
    const rad = currentRotation * Math.PI / 180;
    const baseW = plantInner.offsetWidth * scaleX; 
    const baseH = plantInner.offsetHeight * scaleY;

    ctx.save();
    ctx.translate(centerX, centerY);
    ctx.rotate(rad);
    ctx.scale(effScale, effScale);
    
    ctx.shadowColor = `rgba(0, 0, 0, ${window.SHADOW_OPACITY})`;
    ctx.shadowBlur = 30 * scaleX; 
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 16 * scaleY;

    try { 
      ctx.drawImage(plantMain, -baseW/2, -baseH/2, baseW, baseH); 
    } catch(e){}
    
    ctx.restore();

    // 3. 90ë„ íšŒì „ ì²˜ë¦¬
    const normRot = ((currentRotation % 360) + 360) % 360;
    let finalCanvas = captureCanvas;
    let finalCtx = ctx; 
    const isSide = (Math.abs(normRot - 90) < 0.5 || Math.abs(normRot - 270) < 0.5);

    if (isSide) {
      const rCanvas = document.createElement('canvas');
      rCanvas.width = captureCanvas.height;
      rCanvas.height = captureCanvas.width;
      const rCtx = rCanvas.getContext('2d');
      rCtx.save();
      if (Math.abs(normRot - 90) < 0.5) {
        rCtx.translate(0, rCanvas.height); rCtx.rotate(-Math.PI/2);
      } else {
        rCtx.translate(rCanvas.width, 0); rCtx.rotate(Math.PI/2);
      }
      rCtx.drawImage(captureCanvas, 0, 0);
      rCtx.restore();
      finalCanvas = rCanvas;
      finalCtx = rCtx; 
    }

    // 4. ì›Œí„°ë§ˆí¬ ê·¸ë¦¬ê¸°
    if (headerLogo && headerLogo.complete && headerLogo.naturalWidth > 0) {
      const logoW = Math.min(100, finalCanvas.width * 0.25); 
      const logoH = logoW * (headerLogo.naturalHeight / headerLogo.naturalWidth);
      const margin = 20;

      finalCtx.shadowColor = 'transparent'; 
      finalCtx.shadowBlur = 0;
      finalCtx.shadowOffsetX = 0;
      finalCtx.shadowOffsetY = 0;

      finalCtx.drawImage(headerLogo, margin, margin, logoW, logoH);
    }

    try {
      capturedImage.src = finalCanvas.toDataURL('image/png');
      if (!isSide) {
        const s = (typeof window.CAPTURE_PREVIEW_SCALE === 'number') ? window.CAPTURE_PREVIEW_SCALE : 0.6;
        capturedImage.style.width = (s * 100) + '%';
      } else {
        capturedImage.style.width = '100%';
      }
      capturedImage.style.height = 'auto';
      
      // í™”ë©´ ì „í™˜
      captureResult.classList.add('active');
      setStep(3);
    } catch(e) { console.error(e); showToast('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨'); }
  });

  // ê³µìœ  ê¸°ëŠ¥
  shareBtn.addEventListener('click', async () => {
    if (!capturedImage.src) return;
    try {
      const blob = await (await fetch(capturedImage.src)).blob();
      const file = new File([blob], "namudown_capture.png", { type: blob.type });
      
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({
          files: [file],
          title: 'ë‚˜ë¬´ë‹¤ìš´',
          text: 'ìš°ë¦¬ ì§‘ì— ì–´ìš¸ë¦¬ëŠ” ì‹ë¬¼ì„ ë°°ì¹˜í•´ë³´ì„¸ìš”!',
        });
      } else {
        showToast('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      }
    } catch (error) {
      console.error('ê³µìœ  ì‹¤íŒ¨:', error);
      showToast('ê³µìœ í•˜ê¸° ì‹¤íŒ¨');
    }
  });

  captureCloseBtn.addEventListener('click', () => {
    captureResult.classList.remove('active');
    setStep(2);
  });

  function drawObjectFitCover(ctx, source, cw, ch) {
    const sw = source.videoWidth || source.naturalWidth;
    const sh = source.videoHeight || source.naturalHeight;
    if (!sw || !sh) return;
    const sRatio = sw / sh;
    const cRatio = cw / ch;
    let sx, sy, sWidth, sHeight;
    if (sRatio > cRatio) {
      sHeight = sh; sWidth = sh * cRatio;
      sx = (sw - sWidth) / 2; sy = 0;
    } else {
      sWidth = sw; sHeight = sw / cRatio;
      sx = 0; sy = (sh - sHeight) / 2;
    }
    ctx.drawImage(source, sx, sy, sWidth, sHeight, 0, 0, cw, ch);
  }

  function drawObjectFitContain(ctx, source, cw, ch) {
    const sw = source.naturalWidth;
    const sh = source.naturalHeight;
    if (!sw || !sh) return;
    const sRatio = sw / sh;
    const cRatio = cw / ch;
    let drawW, drawH, sx, sy;
    if (sRatio > cRatio) {
      drawW = cw; drawH = cw / sRatio; sx = 0; sy = (ch - drawH) / 2;
    } else {
      drawH = ch; drawW = ch * sRatio; sx = (cw - drawW) / 2; sy = 0;
    }
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, cw, ch);
    ctx.drawImage(source, 0, 0, sw, sh, sx, sy, drawW, drawH);
  }

  let sDragging = false;
  let sRect = null;
  function setSlider(r) {
    sliderRatio = Math.max(0, Math.min(1, r));
    recomputeSliderScale(); updateSliderThumbPosition(); applyTransform();
  }
  function updateSliderThumbPosition() {
    if (!depthTrack || !depthThumb) return;
    const tr = depthTrack.getBoundingClientRect();
    const th = depthThumb.getBoundingClientRect();
    const l = 8 + (tr.width - th.width - 16) * sliderRatio;
    depthThumb.style.left = l + 'px';
  }
  function dragS(cx) {
    sDragging = true;
    sRect = depthTrack.getBoundingClientRect();
    setSlider((cx - sRect.left) / sRect.width);
  }
  
  [depthTrack, depthThumb].forEach(el => {
    el.addEventListener('mousedown', e => {e.preventDefault(); dragS(e.clientX);});
    el.addEventListener('touchstart', e => {e.preventDefault(); dragS(e.touches[0].clientX);}, {passive:false});
  });
  window.addEventListener('mousemove', e => { if(sDragging) {e.preventDefault(); dragS(e.clientX);} });
  window.addEventListener('touchmove', e => { if(sDragging) {e.preventDefault(); dragS(e.touches[0].clientX);} }, {passive:false});
  window.addEventListener('mouseup', () => sDragging=false);
  window.addEventListener('touchend', () => sDragging=false);
  window.addEventListener('resize', updateSliderThumbPosition);

  renderPlantList();
  resetPlantTransformAndSlider();
  setStep(1);
</script>
</body>
</html>